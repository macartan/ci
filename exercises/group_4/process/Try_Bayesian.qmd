---
title: "6.4_Bayesian"
format: html
editor: visual
---

```{r}
install.packages("rstan", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))

library(StanHeaders)
library(rstan)
library(dagitty)
library(DeclareDesign)
library(CausalQueries)
library(ri2)
library(tidyverse)
library(knitr)
library(kableExtra)
library(rstan)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

# code from slides (adapted)
# creating a multilevel model

ml_model <- '
data {
  vector[400] Y;    
  int<lower=0,upper=1> X[400];
  int school[400];
}
parameters {
  vector<lower=0>[3] sigma; 
  vector[20] a;
  vector[20] b;
  real mu_a;
  real mu_b;
}
transformed parameters {
  vector[400] Y_vx;
  for (i in 1:400) Y_vx[i] = a[school[i]] + b[school[i]] * X[i];
}
model {
  a ~ normal(mu_a, sigma[1]);
  b ~ normal(mu_b, sigma[2]);
  Y ~ normal(Y_vx, sigma[3]);
}
'

##

school   <- rep(1:20, each = 20)
school_b <- 1 + rnorm(20)
X         <- rep(0:1, 50)
Y         <- school_b[school]*X + rnorm(100)

ml_data <- list(
  school = school,
  X = X, 
  Y = Y)
```
