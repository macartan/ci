"0","#| eval: !expr params$run"
"0",""
"0","# tertiary analysis using only preregistered vars"
"0",""
"0","lm_formula_ter_pref <- ""prefer ~ X.7 + L + W.1 + W.2 + W.3 + W.4 + W.5 + L*W.1 + L*W.2 + L*W.3 + L*W.4 + L*W.5 + L*W.2*W.4 + L*W.2*W.5"""
"0",""
"0","ter_vars <- data.frame(var_name = paste0(""W."", 1:5),"
"0","                       var_label = c(""GDP"", ""Vdem"", ""hh income"", "
"0","                                 ""political exclusion"", ""economic exclusion"")) %>% "
"0","  rbind(dimensions %>% "
"0","          mutate(var_name = gsub(""X"", ""X\\."", var_name)))"
"0",""
"0","# using fixest since it's much quicker"
"0",""
"0","# we run on both aggregated and weighted liberalism index"
"0",""
"0","mod_ter_pref <- lapply(c(""aggregated"", ""weighted""), function(x){"
"0","  "
"0","  if(x==""aggregated""){"
"0","    "
"0","    feols(as.formula(lm_formula_ter_pref),"
"0","          df_reduced,"
"0","          cluster = ~country,"
"0","          weights = ~weight_indiv*weight_country)"
"0","    "
"0","  } else {"
"0","    "
"0","    feols(as.formula(lm_formula_ter_pref),"
"0","          df_reduced %>% "
"0","            select(-L, L = L_define),"
"0","          cluster = ~country,"
"0","          weights = ~weight_indiv*weight_country)"
"0","  }"
"0","  "
"0","})"
"2","NOTE: 25,916 observations removed because of NA values (LHS: 12,551, RHS: 17,866).
"
"2","NOTE: 25,916 observations removed because of NA values (LHS: 12,551, RHS: 17,866).
"
"0","# tertiary breakdown"
"0",""
"0","vars <- paste0(""X."", 1:6)"
"0",""
"0","all_f <- "
"0","  lm_formula_ter_pref %>% "
"0","  str_replace(""L"", paste(vars, collapse = ""+"")) %>% "
"0","  str_remove_all(""prefer ~ |\\s"") %>% "
"0","  str_split(""\\+"") %>% "
"0","  unlist()"
"0",""
"0","f1 <- "
"0","  all_f[!grepl(""L"", all_f)]"
"0",""
"0","f2 <- all_f %>% "
"0","  setdiff(f1)"
"0",""
"0","f_new <- paste0(""prefer~"", "
"0","                paste(f1, collapse=""+""), ""+"", "
"0","                paste(f2 %>% sapply(function(x) str_replace(x, ""L"", vars)), collapse = ""+""))"
"0",""
"0","mod_ter_pref_all <- feols(as.formula(f_new),"
"0","                      df_reduced,"
"0","                      cluster = ~country,"
"0","                      weights = ~weight_indiv*weight_country)"
"2","NOTE: 25,916 observations removed because of NA values (LHS: 12,551, RHS: 17,866).
"
"0","list_mods <- c(list(mod_ter_pref_all), mod_ter_pref)"
"0",""
"0","tidy_ter_all <- "
"0","  lapply(1:length(list_mods),"
"0","         function(x){"
"0","           "
"0","           tidy(list_mods[[x]], conf.int = TRUE) %>% "
"0","             .[-1,] %>% "
"0","             filter(grepl(""\\:"", term)) %>% "
"0","             mutate(term = str_replace_all(term, "
"0","                                           setNames(ter_vars$var_label, ter_vars$var_name)),"
"0","                    model = case_when("
"0","                      x==2 ~ ""2a"","
"0","                      x==3 ~ ""2b"","
"0","                      TRUE ~ ""1"""
"0","                    ))"
"0","           "
"0","         }) %>% "
"0","  bind_rows() %>% "
"0","  mutate(attr = factor(str_extract(term, "
"0","                                   paste(dimensions$var_label, collapse=""|"")),"
"0","                       levels = dimensions$var_label),"
"0","         term = str_remove(term, paste(paste0(dimensions$var_label, "":""), collapse=""|""))) %>% "
"0","  filter(!is.na(attr)) %>% "
"0","  mutate(term = str_replace_all(term, ""\\:"", ""*\n"") %>% "
"0","           factor(levels = unique(.)),"
"0","         attr = case_when("
"0","           model==""2a"" & attr==""liberalism index"" ~ ""simple liberalism index"","
"0","           model==""2b"" & attr==""liberalism index"" ~ ""induced liberalism index"","
"0","           TRUE ~ attr"
"0","         ) %>% "
"0","           factor(levels = c(dimensions$var_label,"
"0","                             ""simple liberalism index"","
"0","                             ""induced liberalism index"")))"
"0",""
"0","write.csv(tidy_ter_all, ""../../saved/ter_all_coefs.csv"", row.names = FALSE)"
"0",""
"0","p_ter_all <- "
"0","  tidy_ter_all %>% "
"0","  ggplot(aes(x = estimate, y = term)) +"
"0","  geom_point(position = position_dodge(0.5)) +"
"0","  facet_grid(~attr, labeller = labeller(attr = label_wrap_gen(width = 18))) +"
"0","  geom_errorbar(aes(xmin = conf.low, xmax = conf.high), "
"0","                position = position_dodge(0.5), width=0.2) +"
"0","  geom_vline(xintercept = 0, col = ""red"", linetype = ""dashed"") +"
"0","  ggtitle(""Tertiary analysis"") +"
"0","  scale_y_discrete(labels = function(x) str_wrap(x, width = 10)) +"
"0","  theme_bw() +"
"0","  theme(axis.text.x = element_text(angle = 45)) +"
"0","  ylab("""") +"
"0","  scale_x_continuous(trans = scales::pseudo_log_trans(sigma = 0.01),"
"0","                     breaks = c(-.05, 0, .05, .15))"
"0",""
"0","p_ter_all %>% "
"0","  write_rds(""saved/p_ter_all.rds"")"
"0",""
