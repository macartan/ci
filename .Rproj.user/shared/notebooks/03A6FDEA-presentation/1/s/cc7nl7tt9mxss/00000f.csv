"0","#| eval: !expr params$run"
"0",""
"0","# generate indifference curves"
"0",""
"0","# generate from data before differencing; split outcome into binary choice instead of rating"
"0",""
"0","df_indiff <-"
"0","  df_clean %>%"
"0","  mutate(pref_option = ifelse(prefer>2, ""B"", ""A"")) %>%"
"0","  group_by(part_id, vignette) %>%"
"0","  mutate(prefer = if (""A"" %in% pref_option) 1:0 else 0:1) %>% "
"0","  mutate(X.7 = case_when("
"0","    X.7==0 ~ 1,"
"0","    X.7==(1/3) ~ 2,"
"0","    X.7==(2/3) ~ 3,"
"0","    X.7==1 ~ 4"
"0","  ),"
"0","  L = L*6)"
"0",""
"0","# use rating instead of binary choice"
"0",""
"0","# df_indiff <- "
"0","#   df_clean %>% "
"0","#   group_by(part_id, vignette) %>% "
"0","#   mutate(prefer = c(5-prefer[2], prefer[2])) %>% "
"0","#   ungroup()"
"0",""
"0","# normalize to 0-1"
"0",""
"0","# df_indiff <- "
"0","#   df_indiff %>% "
"0","#   mutate(prefer = (prefer - min(prefer, na.rm = TRUE))/(max(prefer, na.rm = TRUE) - min(prefer, na.rm = TRUE)))"
"0",""
"0","L_levels <- sort(unique(df_indiff$L))"
"0","inc_levels <- sort(unique(df_indiff$X.7))"
"0",""
"0","# get utility from raw data"
"0",""
"0","conditions <- expand.grid(L = L_levels, inc = inc_levels)"
"0",""
"0","# get utility from raw data"
"0",""
"0","utils <-"
"0","  lapply(1:nrow(conditions), function(x){"
"0","    "
"0","    Lib <- conditions$L[x]"
"0","    inc <- conditions$inc[x]"
"0","    "
"0","    pref <- "
"0","      df_indiff %>% "
"0","      filter(L==Lib & X.7==inc) %>% "
"0","      .$prefer"
"0","    "
"0","    conditions[x,] %>% "
"0","      mutate(prefer = mean(pref, na.rm = TRUE),"
"0","             n = length(pref))"
"0","  }) %>% "
"0","  bind_rows()"
"0",""
"0","median_prof <- df_indiff %>% "
"0","  arrange(L, X.7) %>% "
"0","  .[round(median(1:nrow(df_indiff))), c(""L"", ""X.7"")] %>% "
"0","  rename(inc = X.7)"
"0",""
"0","m_pref <- left_join(median_prof, utils) %>% "
"0","  .$prefer"
"2","Joining with `by = join_by(L, inc)`"
"0","p_indiff_curve <- utils %>% "
"0","  mutate(prefer = prefer-m_pref) %>% "
"0","  ggplot() +"
"0","  geom_point(aes(inc, L, col = prefer), alpha = 0) +"
"0","  geom_contour_filled(aes(x = inc, y = L, z = prefer), "
"0","                      binwidth = 0.015,"
"0","                      show.legend = FALSE) +"
"0","  # geom_text(aes(inc, L, label = round(prefer, 2)), left_join(median_prof, utils) %>% "
"0","  #             select(-n),"
"0","  #           col = ""white"", alpha = 0.5, angle = -25) +"
"0","  ggtitle(""Indifference curves between income and liberal values"","
"0","          subtitle = ""Selection probabilities are differences from that of the median profile"") +"
"0","  xlab(""Income"") +"
"0","  ylab(""Liberal index"") +"
"0","  theme_minimal() +"
"0","  scale_color_viridis_c(guide = guide_colourbar(title = ""Probability \ndifference""),"
"0","                        limits = c(-0.15, 0.15), breaks = seq(-0.15, 0.15, length.out = 7)) +"
"0","  scale_y_continuous(breaks = 0:6)"
"0",""
"0","p_indiff_curve %>% "
"0","  write_rds(""saved/p_indiff_curve.rds"")"
"0",""
