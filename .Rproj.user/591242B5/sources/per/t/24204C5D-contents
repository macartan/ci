---
title: "exercises"
author: "Macartan Humphreys"
date: "2024-01-04"
format: 
  html:
    toc: true
    embed-resources: true
filters: 
  - custom-numbered-blocks
custom-numbered-blocks:
  groups: 
    exgrp: 
      collapse: false
      boxstyle: foldbox.simple  
  classes:
    Q:
      group: exgrp
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(tidyverse)
```


# 1: Intro

## 1.1	Course outline, tools, 
## 1.2	Introduction to `DeclareDesign`


::: {.Q #q-ddstartup}



Challenge. False positives and $N$s

* Sometimes people worry that with larger samples you are more likely to get a false positive. Is that true?

* Assess by generating a simple experimental design from scratch in which we can vary the `N` and *in which there is no true effect* of some treatment.


Then:

* Plot the distribution of $p$ values from the `simulations_df`. What shape is it and why?
* Plot the power as $N$ increases, using the `diagnosands_df`
* Plot the estimates against $p$ values for different values of $N$; what do you see?
* Discuss

:::


::: {.Q #q-ses}

Learning about standard errors: Challenge

* The standard error is standard deviation of the sampling distribution of an estimate. 

* That sounds complicated, but actually the sampling distribution of an estimate lives in the simulations data frame so you can look at its standard deviation and assess whether standard errors estimate it well.

*  `Challenge`: Generate a simple experimental design in which there is a correlation (`rho`) between the two potential outcomes (`Y_Z_0` and `Y_Z_1`). (You can use the `fabricatr::correlate` function). 

Assess the performance of the estimates of the standard errors and the coverage as `rho` goes from -1 to 0 to 1. Describe how coverage changes.

:::




::: {.Q #q-ses2}

* Say that you have a set of 20 schools randomly sampled from a superpopulation of schools. There are 5 classrooms in each school and 5 students in each class room.
* Say you assign a treatment at the classroom level. Should you cluster your standard errors at the level of the school or at the level of the classroom?

Now:

* Declare a design with this hierarchical data structure. Allow for the possibility that treatment effects vary at the school level. Assess the performance of the standard errors when you cluster at each of these levels (and when you do not cluster at all.
* Examine whether the performance depends on whether you are interested in the population average effects or the sample average effects.

:::


::: {.Q #q-ses}

Learning about standard errors: Challenge

* The standard error is standard deviation of the sampling distribution of an estimate. 

* That sounds complicated, but actually the sampling distribution of an estimate lives in the simulations data frame so you can look at its standard deviation and assess whether standard errors estimate it well.

*  `Challenge`: Generate a simple experimental design in which there is a correlation (`rho`) between the two potential outcomes (`Y_Z_0` and `Y_Z_1`). (You can use the `fabricatr::correlate` function). 

Assess the performance of the estimates of the standard errors and the coverage as `rho` goes from -1 to 0 to 1. Describe how coverage changes.

:::




::: {.Q #q-confounded}

Declare a design in which:

* The assignment of a  treatment $X$ depends in part on upon some other, binary, variable $W$: in particular  $\Pr(X=1|W=0) = .2$ and $\Pr(X=1|W=1) = .5$)
* The outcome $Y$ depends on both $X$ and $W$: in particular $Y = X*W + u$ where $u$ is a random shock.
* Diagnose a design with three approaches to estimating the effect of $X$ on $Y$: (a) ignoring $W$ (b) adding $W$ as a linear control (c) including both $W$  and an interaction between $W$ and $X$. 

Discuss results.

:::

# 2: Causality

## 2.1	Fundamental problems and basic solutions

::: {.Q #q-pos1}

Potential outcomes

Consider an outcome $Y$ that can be affected by two variables $X_1$ and $X_2$. All variables are binary. Can you fill in the potential outcomes (rows) for each of the column types?

| X1 is a necessary and sufficient condition for Y | X1 is necessary but not sufficient | X1 is sufficient but not necessary | X1 sometimes causes Y but is neither necessary nor sufficient |
|--------------------------------------------------|-------------------------------------|-------------------------------------|----------------------------------------------------------------|
| Y(0,0) =                                          |                                     |                                     |                                                                  |
| Y(1,0) =                                          |                                     |                                     |                                                                  |
| Y(0,1) =                                          |                                     |                                     |                                                                  |
| Y(1,1) =                                          |                                     |                                     |                                                                  |

:::


::: {.Q #q-pos2}

Consider an outcome Y that can be affected by two variables X1 and X2 but say that X2 can itself be affected by X1.  Write down possible potential outcomes for Y1 and X2 when: 	X1 causes X2 and Y, but X1 does not cause Y through X2

Y(0,0) =	__
Y(1,0) =	__
Y(0,1) =	__
Y(1,1) =	__
X2(0) =	__
X2(1) =	__

:::


::: {.Q #q-pos2}

Consider a process with: Y(0,0) =0,   Y(1,0) = 1, Y(0,1) =1, Y(1,1) =1.

* Say X1=1, X2=1. Then Y = 1. What caused Y = 1?
* Say X1=0, X2=0. Then Y = 0. What caused Y = 0?
* Say X1 = 1 with 10% probability, otherwise 0 and, independently,  X2 = 1 with 50% probability, otherwise 0. Then what is the average effect of X1 on Y? What is the average effect of X2 on Y? Which cause has the biggest effect?

:::


## 2.2	General inquiries and causal identification

<!-- See \ref{q-1}. -->

::: {.Q #q-dagitty}

* Draw a DAG with 5 nodes.
* Figure out a set of nodes which, when controlled for, allow for the identification of the effect of $X$ on $Y$
* Represent it in `dagitty` and check your answer

:::

::: {.Q #q-1}

 Make a DAG that is consistent with this distribution

```{r, echo = FALSE}
expand_grid(A=0:1, B = 0:1, C= 0:1)|> 
  mutate(p = rep(1/8,8)) |>
  kable()
```

:::


::: {.Q #q-dag2}


Make a DAG that is consistent with this distribution

```{r, echo = FALSE}
expand_grid(A=0:1, B = 0:1, C= 0:1)|> 
  mutate(p = c(.64, .16, .16, .04,  .16, .24, .24, .36)/2) |>
  kable()

```

:::



# 3: Estimation and Inference

## 3.1	Frequentist

::: {.Q #q-lin}

Replicate Table 1 in @lin2012agnostic; ignore first rows which are theoretical results; include standard errors of  estimates (these are not included in Table 1 but are produced by `diagnose_design`); 'Tyranny of the minority' estimator is optional.

:::

::: {.Q #q-controls}

Sometimes researchers running an experiment look for imbalance on a covariate and then include the covariate as a control if and only if they see imbalance. Set up a design in which a covariate may or may not affect potential outcomes and assess the performance given different rules 

* no control 
* control as a function of correlations of covariates with outcomes
* control as a function of correlations of covariates with outcomes in control only
* control as a function of correlations of covariates with treatments
* control regardless of correlations


:::




::: {.Q #q-missing}

Missing data on controls

Say you want to include a control variable. But you have missingness in the control. Should you proceed and what can you do about it?

Declare a design for an experiment in which a binary covariate X is related to potential outcomes, according to `b`, and so to treatment effects.  Say `X` is missing with probability `p`. 


Compare answer strategies in which you:

(a) do not control for $X$ 
(b) do control for $X$ but drop whenever $X$ is missing and 
(c) Treat $X$ as a block in your analysis design with three values (0, 1, and missing). 

Assess performance (RMSE) over a range of values for `p` and `b`. How do you think the comparison of strategies depends upon N? 

:::


::: {.Q #q-blockestimates}

Consider the following data. Treatment is assigned in two blocks. One third of block 1 got treatment (randomly); one third of block two got treatment (randomly). The data are as below:

| Block | Z | Y |
|-------|---|---|
| 1     | 0 | 0 |
| 1     | 0 | 0 |
| 1     | 1 | 1 |
| 2     | 0 | 0 |
| 2     | 0 | 0 |
| 2     | 1 | 0 |
| 2     | 1 | 0 |
| 2     | 1 | 1 |
| 2     | 1 | 1 |

* Can you estimate the ATE? How about the ATT? And the ATC?
* How do these compare to a simple difference in means between treatment and control? 
* What would you get if you did OLS and controlled for block?

:::

::: {.Q #q-propensities}

Propensities

Two of four units are going to be assigned to treatment. A researcher sets up a design in which subjects can decide for themselves the probability with which they receive a treatment. Requested propensities are as below. 

Can you :

1.	List the set of admissible treatment allocations
2.	Describe a scheme for allocating subjects to treatment
3.	Calculate your estimate under each allocation
4.	Assess whether your estimate will be biased or not.

|----------------|--------|--------|
| Requested propensity	| Y0	| Y1| 
| 0.2	|0	|1 |
|0.4	|0	|2 |
|0.6	|1	|3 |
|0.8	|1	|4 |

[This is hard and long; so focus on the principles even if you do not have time to do all the calculations]

:::


::: {.Q #q-weights}

what weights

Say you sampled subject A with probability .6 and subject B with probability .4. Say you assigned each to treatment with probability .6. What weight should you put on A in your analysis if they end up in treatment? What if they end up in control? How about B?

:::


::: {.Q #q-hyp}


Hypothesis testing
Say there are 20 students. One of them is randomly assigned to have an extra maths class. They take a test and are given grades. The student that got the extra class scored 73% which is higher than any of the other 19 students. 

You are interested in calculating a p value for the hypothesis that the math class had no effect on grades. As a test statistic you use the difference in means between the treated student and the rest. What is the probability that the difference you see is so big under the null of no effect?

:::

::: {.Q #q-ci}

Confidence Intervals

Consider the same problem and say there were a gazillion students with grades spread evenly between 0 and 100.  Say there was one treated student and this student had a grade of 95%. The difference in means estimate for the treatment effect is 45. Under the assumption of homogeneous treatment effects (and so allowing for the possibility that grades could go over 100 for treated units) can you construct a 90% confidence interval for this estimate. 
:::


## 3.2	Bayesian 

::: {.Q #pt}

PT by hand

1. **Simple process tracing**. Consider a "hoop" test: Say $Pr(K|H) = 1, Pr(K|\neg H) = .5$. For each possible prior on $p(H)$ over $0,1$ graph your posterior or $H$ if $K$ is observed. Graph the posterior for when $K$ is not observed.

2. **Simple correlation inference.** You know in a population that $X=1$ about half the time and that $Y=1$ about half the time; otherwise 0. Say you have  a prior that puts equal weight on the possibilites that (a) $X$ causes $Y$ for all units (ie $Y=1$ iff $X=1$), and (b) $X$ and $Y$ are orthogonal to each other.
   * What do you infer if you observe only one case and $X \neq Y$
   * What do you infer if you observe only one case and $X = Y$
   * What do you infer if you 100 cases and  $X = Y$ in 99 of these and  $X \neq Y$ in one of these? (Bonus: in this case what is the $p$ value for the hypothesis that $X$ does not cause $Y$ )

:::

# 4: Design

## 4.1	Experimental Design


::: {.Q #q-rand1}

Randomization

100 students sign up to take part in an experiment. You want to measure the effect of immigration on social trust. Half your subjects are men and half are women and you believe gender is very predictive of social trust. 

Your experiment involves varying whether a “native” or an “immigrant” facilitator instructs players in how to play a trust game.  You have five native and five immigrant facilitators and you want them each to conduct one session with 10 subjects. 

* 	You are free to assign both subjects and facilitators to sessions. Propose an appropriate randomization strategy.  Is it blocked? Clustered? Both?

*	Say now that subjects have already signed up for sessions. You can only assign facilitators to sessions, but you have access to the subject lists before you do so. Describe your optimal randomization strategy.  Is it blocked? Clustered? Both?

:::


::: {.Q #q-rand2}

Network Randomization

You have access to a network of all friendship links in a classroom. You want to provide political information to a set of students and see how muc more likely it is that a student that you do not give information to receives the information if a friend is treated compared to the situation in which a friend of a friend is treated.  So you want to be sure that some subjects have friends treated and some have only friends of friends treated. How would you assign treatment? How can you work out your treatment assignment probabilities? 

:::


## 4.2	Design evaluation

::: {.Q #q-blocks}

Assess

* Power for an interaction (in a factorial design)
* Power for a binary variable (versus a continuous variable?)
* Power from adding covariates in the analysis stage
* Power gains from blocked randomization
* Power losses from clustering at different levels

:::


::: {.Q #q-blocks}

Gain from covariates

Equation (4.6) in FEDAI suggests that if the sum of two slopes exceeds 1 then there are gains in efficiency from adding a covariate. Show that this is true in practice using a design declaration.

:::

::: {.Q #q-blocks}

Comparing estimators

It is not uncommon that different units are assigned to treatments with different probabilities. e.g. men and women, or people in different counties. This might happen for example if 100 people are selected from each group but groups are different sizes. But there can be many reasons for this.

The go-to approach is to control for blocks using fixed effects. But this is not guaranteed to be correct.


Declare a design that compares different approaches to taking account for blocks. e.g.

* Fixed effects
* Blocked differences in means
* The saturated (Lin) estimator
* IPW
* Horvitz Thompson

Compare how they perform in terms of the  bias of the effect estimate and the bias of the standard error estimate.

Try with three blocks with different assignment probabilities and also with heterogeneous effects by group.

:::


# 5 Practice 

## 5.1	Topics and techniques

::: {.Q #q-spillovers}

Imagine a study with three subjects. Each subjects potential outcomes are as follows:

* 	0 if in control
* 	n if in treatment and n subjects are assigned to treatment

So for example if one unit is in treatment that unit has outcome Y=1, and the others have Y = 0; if all 3 are in treatment they all have Y=3. 

1.	Write down the potential outcomes for all possible assignments, including all and none assigned o treatment
2.	Write down the difference in means calculation for each possible assignment
3.	Define two estimands of interest.
4.	Define a randomization scheme that will return an unbiased estimate of each estimand.
5.	Define a randomization scheme that will return a biased estimate of each estimand.

:::


::: {.Q #q-late}

LATE

Which of these problems could be addressed using instrumental variables. In each case what kinds of concern might you have about the IV strategy?

1.	Experimenters introduce a unconditional cash transfers into a set of villages in 2012 and use it to measure access school attendance in 2015. You come on the scene later and are interested in whether the transfer could have led to greater political participation in 2017. 
2.	Experimenters introduce an unconditional cash transfers into a set of villages in 2012 and use it to measure access school attendance in 2015. You come on the scene later and are interested in whether the increased school attendance could have led to greater political participation in 2017.
3.	You want to understand the effects of attending a rally on subsequent support for a candidate. You send a random set of voters a flyer about an upcoming demonstration.
4.	You want to understand the effects of attending a rally on subsequent support for a candidate. You send a random set of voters a flyer about an upcoming demonstration but you find out later that your enumerators did not deliver the flyers in a bunch of areas.
5.	You want to understand the effects sending flyers about an upcoming demonstration but you find out later that your computer code used incomplete data when making assignments and so failed to assign treatment to a whole bunch of regions.
6.	You want to understand whether sending flyers increases participation because people actually go to the rallies or because people’s general level awareness of the election increases, whether or not they go. 

:::

## 5.2	Open science





