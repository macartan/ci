---
title: "Lebanon project design"
author: Jonah Foong, Macartan Humphreys, Nora Chirikure
date: "`r Sys.Date()`"
format: 
  html:
    embed-resources: true
    code-fold: true
---

```{r setup}
#| include: false

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(randomizr)
library(fabricatr)
library(estimatr)
library(DeclareDesign)
library(kableExtra)
library(truncnorm)
library(faux)
library(plotly)
library(tidyverse)
library(knitr)
#remotes::install_github("macartan/probra")
library(probra)

run <- FALSE
```

## 1 Background

With the multifaceted economic and financial crisis in Lebanon comes difficulties in the state’s ability to ensure service delivery, particularly in already marginalized localities such as those in the Beqaa, Shouf and some Mount Lebanon areas. In the absence of state-led initiatives at the level of the central authority, municipalities across different regions in Lebanon are leading on service-provision projects. However, municipalities across Lebanon face challenges in executing projects in the absence of state resources and limited accountability measures. 

This can lead up to built-up dissatisfaction with the local governance structures, eroding trust in authorities. Participatory planning and decision-making processes between representatives of municipalities, civil society and residents towards choosing different measures and projects to improve the community’s socioeconomic situation can help diffuse such tensions and increase trust and cohesion with the local governance structure. The aim of this project is thus to strengthen trust and cohesion between municipalities and residents of the area by including target beneficiaries into the decision-making processes regarding measures and projects that aim at improving the socioeconomic situation of the locality.

## 2 Theory and Hypotheses 

The impact assumption and theory of change is as follows:
If 1) inhabitants/citizens of a municipality (locality) are engaged in an inclusive manner in the identification of socioeconomic needs, prioritizing and selecting projects/measures together with the municipal administration AND 2) the capacities of local government and inhabitants/citizens are built regarding participatory approaches as well as dialogue, mediation and conflict resolution AND 3) the inhabitants/citizens and municipality are continuously informed about the implementation progress, THEN vertical social cohesion and trust in the local ability to act is achieved. 

In this research project, citizens are randomly sampled to join committees tasked with contributing to community project decisions. The random assignment lets us compare trust outcomes for those that take part in the community meetings with those that do not. We hypothesize that the trust outcomes of those who are randomly selected to take part in the community meetings will improve. We measure trust using a suite of survey instruments as described in Section 4. 

## 3 Design 

The Berghof Foundation (BF) will organize and facilitate participatory planning and decision-making processes between representatives of municipalities, civil society and inhabitants/citizens in 25 municipalities. In each municipality, 3 working groups (WG) (some municipalities can have 2, others 4, depending on their size) - each comprised of 15 members- will be formed with the aim of discussing the socioeconomic needs of the area, gaps and needed measures or projects to better the situation, and then jointly prioritize and select the needed measures. The 15 WG members will be divided as follows: 10 chosen members from experts, municipality officials and influential community leaders, and 5 members of the local community chosen at random. Wherever possible, we will try to have a more balanced ratio of chosen vs. randomly selected WG members.  

Following the recruitment of the 10 chosen WG members but before the participatory meetings start, a baseline survey of inhabitants will be conducted for WG members for the purpose of the Rigorous Impact Evaluation (RIE) to evaluate the baseline level of trust in the local authority’s ability to act. This baseline survey will identify individuals that are willing to participate in community meetings (at least 50). From this pool, 15 adults will be randomly selected (with gender and citizenship balance using block randomisation, and excluding individuals already selected to the WGs) and randomly invited to take part in one of the three committee groups. These additional 5 members will be inducted into the working group before activities with the groups begin.

## 4 Survey Data

The data collected at the various stages of the research will be as follows: 

### 4.1 Baseline data 

*   Willingness to take part in meetings
*   Baseline levels of attitudinal measures e.g. trust in authorities and other groups
*   Any variables used for blocking – e.g. demographics
*   Baseline preferences over priority projects
    
### 4.2 Process data 

*   Records of dates of group meetings
*   Attendance at meetings
*   Record of notable events
*   Project implementation quality (value for money, efficiency of implementation)

### 4.3 Endline Data 

*   Perception of project 
*   Satisfaction with project decisions 
*   Endline measures of attitudinal measures e.g. trust in authorities and other groups
*   Endline preferences over priority projects

We may not see such effects for something as slow-moving as governmental trust. The latent outcome variable will consist of a weighted index score of variables/ Principal Component Analysis (TBD). We measure trust using a suite of survey instruments as shown in the table below.

### 4.4 Mesauring the Outcome Variable:
    
The dependent variable will be a weighted index score based on the following questions: 

Q 5.1	To what extent do you agree with the following statements: 
Q 5.1a	I trust that my local government acts in the interests of its citizens.
Q 5.1b	I believe that the resource-distribution by the municipal board is fair.
Q 5.1c	I have information about decisions taken by the municipality.
Q 5.1d	Corruption is widespread in local government.

## 5. Analyses

We measure trust outcomes as an index of variables xxx. We run a simple linear regression of the form 

$$Y_{i} = \alpha + \beta X_{i} + \gamma_c + \epsilon_i$$

where $i$ represents an individual and $Y$ is the dependent variable made up of a weighted index of measures of trust. $\alpha$ is the intercept term.  $\beta$ is the coefficient term for the dummy variable for treatment which indicates whether an individual took part in community meetings or not, X. $\gamma_c$ is the fixed effect at the municipal level and $\epsilon_{i}$ is the error term. We cluster standard errors at the working group level. 

### 5.1 Robustness checks 

As a robustness check we will change the weights of the outcome variable. 
    
## 6 Using the Design

We report various aspects of our design and confirm unbiasedness of estimates using simulated data. We assume effect sizes of 0.2 standard deviations and icc of 0.2. 


### helper functions and assumptions

```{r}

# assumptions

n <- 100 # sample size per muni
n_muni <- 25
m <- 5 # participants per wg
n_wg <- 3 # number of wgs
b <- .2 # treatment effect in sds
n_wg_total <- n_wg*n_muni
icc <- 0.2
het_f <- 0.1 # heterogeneous effect for women
het_m <- 0.1 # heterogeneous effect for minorities

f_prop <- 0.3 # proportion of women in sample
m_prop <- 0.2 # proportion of minorities in sample

wgs <- rep(paste0("wg", 1:n_wg), each = m)

# nasty assignment function that should be cleaned;
# currently it block assigns to treatment according to specified probs, then random assigns to WG

block_assign <- function(data){
  
  data %>% 
    group_by(municipality) |> 
    mutate(prob = case_when(
      female==0 & minority==0 ~ 1,
      female==0 & minority==1 ~ 2,
      female==1 & minority==0 ~ 1,
      female==1 & minority==1 ~ 2
    ),
    prob = n_wg*m*prob/sum(prob),
    treated = prob_ra(prob = prob,
                      blocks = paste(female, minority)), 
    ipw = treated*(1/(prob)) + (1 - treated)*(1/(1 - prob))) |>
    ungroup() |>
    group_by(municipality, treated) %>% 
    mutate(wg = sample(if(mean(treated)==1) wgs else rep(NA, n()), 
                            size = n()),
           cluster = ifelse(treated==0, subjects, wg))
}

```

```{r}

design <- 
  declare_model(
    municipality = add_level(N = 25),
    subjects = add_level(N = n,
                         female = simple_ra(N, prob = f_prop),
                         minority = simple_ra(N, prob = m_prop))) +
  declare_measurement(handler = block_assign) +
  declare_measurement(shock = draw_normal_icc(clusters = cluster, ICC = icc)) +
  declare_measurement(Y = b*treated + het_f*female*treated + het_m*minority*treated + shock) +
  declare_inquiry(ATE = b,
                  het_female = het_f,
                  het_minority = het_m) +
  declare_estimator(Y ~ treated*female + treated*minority|municipality,
                    term = c("treated", 
                             "treated:female",
                             "treated:minority"),
                    weights = ~ipw,
                    inquiry = c("ATE", "het_female", "het_minority"),
                    cluster = ~ cluster, 
                    .method = fixest::feols,
                    .summary = function(x) broom::tidy(x, conf.int = TRUE))
```

### Data

```{r}

df <- draw_data(design)

head(df)

```

What does our assignment yield?

```{r}

table(df$treated, df$municipality)

df %>% 
  filter(treated==1) %>% 
  summarise(mean_f = mean(female),
            mean_m = mean(minority)) %>% 
  kable(digits = 3, caption = "probability of assignment to treatment for female and minority")


```


### Diagnosis


```{r}
#> Looks about right in that the power slowly increases but the slope is rather flat
#> What's probably happening is, the cluster shock is really large and so increasing number of clusters does much more than increasing numbers within cluster

if(run) 
design |>
  diagnose_design(sims = 500) |>
  write_rds("saved/diagnoses.rds")

```

```{r}

diagnosis <- read_rds("saved/diagnoses.rds")

diagnosis %>% 
  reshape_diagnosis() %>% 
  kable()


```

