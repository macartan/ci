---
title: "exercises"
author: "Macartan Humphreys"
date: "2024-01-04"
format: 
  html:
    toc: true
    number-sections: true
    embed-resources: true
bibliography: ../slides/bib.bib
filters: 
  - custom-numbered-blocks
custom-numbered-blocks:
  groups: 
    exgrp: 
      collapse: false
      boxstyle: foldbox.simple  
  classes:
    Q:
      group: exgrp
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(tidyverse)
library(CausalQueries)

```

Class: [https://macartan.github.io/ci/](https://macartan.github.io/ci/)

For each puzzle: explore the issues raised by the puzzle and generate a self contained presentation in `.qmd` (or `.Rmd`) that reports on your investigations. Present in the next class session. 


# Course outline, tools, 

# Introduction to `DeclareDesign`

::: {.Q #q-ddstartup}

**False positives and $N$s**

* Sometimes people worry that with larger samples you are more likely to get a false positive. Is that true?

* Assess by generating a simple experimental design from scratch in which we can vary the `N` and *in which there is no true effect* of some treatment.

Then:

* Plot the distribution of $p$ values from the `simulations_df`. What shape is it and why?
* Plot the power as $N$ increases, using the `diagnosands_df`
* Plot the estimates against $p$ values for different values of $N$; what do you see?
* Discuss

:::





::: {.Q #q-ses2}

**Clustering** 

* Say that you have a set of 20 schools randomly sampled from a superpopulation of schools. There are 5 classrooms in each school and 5 students in each class room.
* Say you assign a treatment at the classroom level. Should you cluster your standard errors at the level of the school or at the level of the classroom?

Now:

* Declare a design with this hierarchical data structure. Allow for the possibility that treatment effects vary at the school level. Assess the performance of the standard errors when you cluster at each of these levels (and when you do not cluster at all.
* Examine whether the performance depends on whether you are interested in the population average effects or the sample average effects.

:::


::: {.Q #q-ses}

**Learning about standard errors** 

* The standard error is standard deviation of the sampling distribution of an estimate. 

* That sounds complicated, but actually the sampling distribution of an estimate lives in the simulations data frame so you can look at its standard deviation and assess whether standard errors estimate it well.

*  `Challenge`: Generate a simple experimental design in which there is a correlation (`rho`) between the two potential outcomes (`Y_Z_0` and `Y_Z_1`). (You can use the `fabricatr::correlate` function). 

* Show the distribution of the estimates over different values of `rho`

* Assess the performance of the estimates of the standard errors and the coverage as `rho` goes from -1 to 0 to 1. Describe how coverage changes. (Be sure to be clear on what coverage is!)

:::




::: {.Q #q-confounded}

**Confounded.** 

Declare a design in which:

* The assignment of a  treatment $X$ depends in part on upon some other, binary, variable $W$: in particular  $\Pr(X=1|W=0) = .2$ and $\Pr(X=1|W=1) = .5$)
* The outcome $Y$ depends on both $X$ and $W$: in particular $Y = X*W + u$ where $u$ is a random shock.
* Diagnose a design with three approaches to estimating the effect of $X$ on $Y$: (a) ignoring $W$ (b) adding $W$ as a linear control (c) including both $W$  and an interaction between $W$ and $X$. 

Discuss results. Do any of these return the right answer?

:::

# Causality: 	Fundamental problems

## Potential outcomes

::: {.Q #q-pos1}

Potential outcomes

Consider an outcome $Y$ that can be affected by two variables $X_1$ and $X_2$. All variables are binary. Can you fill in the potential outcomes (rows) for each of the column types?

| X1 is a necessary and sufficient condition for Y | X1 is necessary but not sufficient | X1 is sufficient but not necessary | X1 sometimes causes Y but is neither necessary nor sufficient |
|--------------------------------------------------|-------------------------------------|-------------------------------------|----------------------------------------------------------------|
| Y(0,0) =                                          |                                     |                                     |                                                                  |
| Y(1,0) =                                          |                                     |                                     |                                                                  |
| Y(0,1) =                                          |                                     |                                     |                                                                  |
| Y(1,1) =                                          |                                     |                                     |                                                                  |

:::


::: {.Q #q-pos2}

Consider an outcome Y that can be affected by two variables X1 and X2 but say that X2 can itself be affected by X1.  Write down possible potential outcomes for Y1 and X2 when: 	X1 causes X2 and Y, but X1 does not cause Y through X2

Y(0,0) =	__
Y(1,0) =	__
Y(0,1) =	__
Y(1,1) =	__
X2(0) =	__
X2(1) =	__

:::


::: {.Q #q-pos2}

Consider a process with: Y(0,0) =0,   Y(1,0) = 1, Y(0,1) =1, Y(1,1) =1.

* Say X1=1, X2=1. Then Y = 1. What caused Y = 1?
* Say X1=0, X2=0. Then Y = 0. What caused Y = 0?
* Say X1 = 1 with 10% probability, otherwise 0 and, independently,  X2 = 1 with 50% probability, otherwise 0. 

Then what is the average effect of X1 on Y? What is the average effect of X2 on Y? Which cause has the biggest effect?

:::


::: {.Q #q-diff}

* A set of units have outcome $Y^1_i$ at baseline.
* At endline they have potential outcomes $Y^2_i(0)$ and  $Y^2_i(1)$


1. Write down the estimand for the average effect of treatment on endline outcomes
2. Write down the estimand for the average effect of treatment on the change from baseline to endline for all units

Compare these and discuss.

:::




# Inquiries and  identification

<!-- See \ref{q-1}. -->

::: {.Q #q-dagitty}

* Draw a DAG with 5 nodes representing  a situation in which $X$ causes $Y$ though $M$, $C$ affects both $X$ and $M$ and $D$ affects both $M$ and $Y$.
* Figure out a set of nodes which, when controlled for, allow for the identification of the effect of $X$ on $Y$
* Represent it in `dagitty` and check your answer

:::



::: {.Q #q-dag2}


Make a DAG that is consistent with this distribution

```{r, echo = FALSE}
expand_grid(A=0:1, B = 0:1, C= 0:1)|> 
  mutate(p = c(.64, .16, .16, .04,  .16, .24, .24, .36)/2) |>
  kable()

```

:::




::: {.Q #q-dag2}


Imagine a model that looks like this:

```{r, echo = FALSE, fig.height = 3, fig.width = 10}
make_model("X -> M -> Y <-> X") |> plot(x_coord = 1:3, y_coord = c(1,1,1))
```

* Say that in truth  ATE of  $X$ on $M$ is .9 and that the ATE of  $M$ on $Y$ is .9. Is the implied effect of 0.81 on $X$ on $Y$ identified?   
* Say that in truth  ATE of  $X$ on $M$ is 1 and that the ATE of  $M$ on $Y$ is 1. Is the implied effect of 1 on $X$ on $Y$ identified?   
* Discuss 

:::




# Estimation and Inference: Frequentist


::: {.Q #q-blockestimates}

Consider the following data. Treatment is assigned in two blocks. One third of block 1 got treatment (randomly); one third of block two got treatment (randomly). The data are as below:

| Block | Z | Y |
|-------|---|---|
| 1     | 0 | 0 |
| 1     | 0 | 0 |
| 1     | 1 | 1 |
| 2     | 0 | 0 |
| 2     | 0 | 0 |
| 2     | 1 | 0 |
| 2     | 1 | 0 |
| 2     | 1 | 1 |
| 2     | 1 | 1 |

* Can you estimate the ATE? How about the ATT? And the ATC?
* How do these compare to a simple difference in means between treatment and control? 
* What would you get if you did OLS and controlled for block?

:::


::: {.Q #q-weights}

**what weights**

Say you sampled subject A with probability .6 and subject B with probability .4. Say you assigned each to treatment with probability .6. What weight should you put on A in your analysis if they end up in treatment? What if they end up in control? How about B?

:::


::: {.Q #q-lin}

Replicate Table 1 in @lin2012agnostic; ignore first rows which are theoretical results; include standard errors of  estimates (these are not included in Table 1 but are produced by `diagnose_design`); 'Tyranny of the minority' estimator is optional.

:::





::: {.Q #q-missing}

Missing data on controls

Say you want to include a control variable. But you have missingness in the control. Should you proceed and what can you do about it?

Declare a design for an experiment in which a binary covariate X is related to potential outcomes, according to `b`, and so to treatment effects.  Say `X` is missing with probability `p`. 


Compare answer strategies in which you:

(a) do not control for $X$ 
(b) do control for $X$ but drop whenever $X$ is missing and 
(c) Treat $X$ as a block in your analysis design with three values (0, 1, and missing). 

Assess performance (RMSE) over a range of values for `p` and `b`. How do you think the comparison of strategies depends upon N? 

:::


# Bayesian 


::: {.Q #q-POC}

* Set up a model in which $X \rightarrow Y$ ($X$ as if $Y$) and there is a true effect of 0.56.
* Update using large data generated according to some distribution over causal types
* Calculate a  posterior on the share of  $X=1, Y=1$ cases for which $Y=1$ is due to $X=1$
* Say you know that the effect of $X$ on $Y$ passes through $M$ and so you have model $X \rightarrow M \rightarrow Y$ and effects of 0.8 at the first stage and .7 at the second stage.
* Update using large data generated according to some distribution over causal types
* Calculate a  posterior on the share of  $X=1, Y=1$ cases for which $Y=1$ is due to $X=1$ (a) when you know that $M=1$ and (b) when you know that $M=0$

:::



To come

# Experimental Design


::: {.Q #q-rand1}

Randomization

100 students sign up to take part in an experiment. You want to measure the effect of immigration on social trust. Half your subjects are men and half are women and you believe gender is very predictive of social trust. 

Your experiment involves varying whether a “native” or an “immigrant” facilitator instructs players in how to play a trust game.  You have five native and five immigrant facilitators and you want them each to conduct one session with 10 subjects. 

* 	You are free to assign both subjects and facilitators to sessions. Propose an appropriate randomization strategy.  Is it blocked? Clustered? Both?

*	Say now that subjects have already signed up for sessions. You can only assign facilitators to sessions, but you have access to the subject lists before you do so. Describe your optimal randomization strategy.  Is it blocked? Clustered? Both?

:::


::: {.Q #q-propensities}

Heterogeneous propensities

Two of four units are going to be assigned to treatment. A researcher sets up a design in which subjects can decide for themselves the probability with which they receive a treatment. Requested propensities are as below. 

Can you :

1.	List the set of admissible treatment allocations
2.	Describe a scheme for allocating subjects to treatment
3.	Calculate your estimate under each allocation
4.	Assess whether your estimate will be biased or not.

| Requested propensity	| Y0	| Y1| 
|----------------|--------|--------|
| 0.2	|0	|1 |
|0.4	|0	|2 |
|0.6	|1	|3 |
|0.8	|1	|4 |


:::



::: {.Q #q-rand2}

Network Randomization

You have access to a network of all friendship links in a classroom. You want to provide political information to a set of students and see how muc more likely it is that a student that you do not give information to receives the information if a friend is treated compared to the situation in which a friend of a friend is treated.  So you want to be sure that some subjects have friends treated and some have only friends of friends treated. How would you assign treatment? How can you work out your treatment assignment probabilities? 

:::


# Design evaluation

::: {.Q #q-blocks}

**Covariates 1**

Compare the power gains from two strategies:

* Adding covariates in the analysis stage
* Blocked randomization in the design stage

:::


::: {.Q #q-blocks}

**Covariates 2**

Equation (4.6) in @gerber2012field suggests that if the sum of two slopes exceeds 1 then there are gains in efficiency from adding a covariate. Show that this is true in practice using a design declaration.

:::

::: {.Q #q-blocks}

**Covariates 3**

Compare the performance of the Lin estimator an the doubly robust estimator dicussed in slides

:::


::: {.Q #q-controls}

**Covariates 4**

Sometimes researchers running an experiment look for imbalance on a covariate and then include the covariate as a control if and only if they see imbalance. Set up a design in which a covariate may or may not affect potential outcomes and assess the performance given different rules 

* no control 
* control as a function of correlations of covariates with outcomes
* control as a function of correlations of covariates with outcomes in control only
* control as a function of correlations of covariates with treatments
* control regardless of correlations


:::


# Topics and techniques

::: {.Q #q-spillovers}

**Spillovers**

Imagine a study with three subjects. Each subject's potential outcomes are as follows:

* 	0 if in control
* 	$n$ if in treatment when $n$ subjects are assigned to treatment

So for example if one unit is in treatment that unit has outcome Y=1, and the others have Y = 0; if all 3 are in treatment they all have Y=3. 

1.	Write down the potential outcomes for all possible assignments, including all and none assigned o treatment
2.	Write down the difference in means calculation for each possible assignment
3.	Define two estimands of interest.
4.	Define a randomization scheme that will return an unbiased estimate of each estimand.
5.	Define a randomization scheme that will return a biased estimate of each estimand.

:::



::: {.Q #q-mediation}

**Mediation**

Baron Kenny have provided a popular method to implement mediation analysis.

Declare a design with a mediation process and possible violations of sequential ignorability, governened by some parameters `k`.

Demonstrate under what conditions  estimates using the Baron-Kenny procedure are misleading.


:::


::: {.Q #q-diffdiff}
**Difference in Differences**

[DD 16.3](https://book.declaredesign.org/library/observational-causal.html#sec-ch16s3) shows poor behavior of a multi period difference in differences design when there is effect heterogeneity.

[@imai2021use](https://web.mit.edu/insong/www/pdf/FEmatch-twoway.pdf) highlights the risk of negative weights in this setting.  Can you recover the implied weights and identify which units contribute negatively to estimates?

:::

::: {.Q #q-late}

**LATE**

Which of these problems could be addressed using instrumental variables? In each case, what kinds of concern might you have about the IV strategy?

1.	Experimenters introduce a unconditional cash transfers into a set of villages in 2012 and use it to measure access school attendance in 2015. You come on the scene later and are interested in whether the transfer could have led to greater political participation in 2017. 
2.	Experimenters introduce an unconditional cash transfers into a set of villages in 2012 and use it to measure access school attendance in 2015. You come on the scene later and are interested in whether the increased school attendance could have led to greater political participation in 2017.
3.	You want to understand the effects of attending a rally on subsequent support for a candidate. You send a random set of voters a flyer about an upcoming demonstration.
4.	You want to understand the effects of attending a rally on subsequent support for a candidate. You send a random set of voters a flyer about an upcoming demonstration but you find out later that your enumerators did not deliver the flyers in a bunch of areas.
5.	You want to understand the effects sending flyers about an upcoming demonstration but you find out later that your computer code used incomplete data when making assignments and so failed to assign treatment to a whole bunch of regions.
6.	You want to understand whether sending flyers increases participation because people actually go to the rallies or because people’s general level awareness of the election increases, whether or not they go. 

:::

# Open science

No exercises




# References
